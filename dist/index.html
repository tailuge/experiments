<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Minimal TF.js Next-Token Predictor with Loss Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h3>Training Data (one sample per line):</h3>
  <textarea id="trainingData" rows="5" cols="80">
abcdefghijklmnopqrstuvwxyz.
zyxwvutsrqponmlkjihgfedcba.
abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz
zyxwvutsrqponmlkjihgfedcbaabcdefghijklmnopqrstuvwxyz
    </textarea>
  <br />

  <label for="epochs">Epochs:</label>
  <input type="number" id="epochs" value="5" min="1" max="50" style="width: 50px" />
  <button id="trainButton" onclick="trainModel()">Train Model</button>
  <span id="trainSpinner" class="spinner"></span>

  <h3>Inference:</h3>
  <input type="text" id="inputText" value="abc" />
  <button onclick="runInference()">Test</button>
  <div id="result" style="margin-top: 10px; font-weight: bold"></div>

  <h3>Training Status:</h3>
  <pre id="trainingStatus" style="background: #f0f0f0; padding: 5px"></pre>

  <h3>Training Loss Graph:</h3>
  <canvas id="lossChart" width="600" height="150"></canvas>

  <script src="charting.js"></script>
  <script>
    // --- Global Constants & Variables ---
    const SEQ_LENGTH = 24;
    const VOCAB_SIZE = 128;

    let model;
    let globalEpochCounter = 0;

    // --- Model Definition ---
    function createModel() {
      const model = tf.sequential();
      model.add(tf.layers.embedding({
        inputDim: VOCAB_SIZE,
        outputDim: 8,
        inputLength: SEQ_LENGTH,
      }));
      model.add(tf.layers.lstm({ units: 4 }));
      model.add(tf.layers.dense({
        units: VOCAB_SIZE,
        activation: "softmax",
      }));
      console.log("Model created");
      return model;
    }

    model = createModel();
    console.log("Compile model");
    model.compile({
      optimizer: tf.train.adam(),
      loss: "sparseCategoricalCrossentropy",
    });
    spinner.style.display = "none";

    // --- Data Preparation ---
    // For each training sample (one per line), slide a window of SEQ_LENGTH and use the following character as the target.
    function prepareData() {
      const rawData = document
        .getElementById("trainingData")
        .value.split("\n")
        .map((line) => line.trim())
        .filter((line) => line.length > 0);
      const inputs = [];
      const labels = [];
      rawData.forEach((line) => {



      });

    }

    // --- Training Function ---
    async function trainModel() {
      const trainButton = document.getElementById('trainButton');
      const spinner = document.getElementById('trainSpinner');

      // Disable button and show spinner.
      trainButton.disabled = true;
      spinner.style.display = "inline-block";
      document.getElementById("trainingStatus").textContent = "";

      try {
        const { xs, ys } = prepareData();
        const epochs = parseInt(document.getElementById("epochs").value, 10);
        console.log("Starting fit");
        await model.fit(xs, ys, {
          epochs: epochs,
          callbacks: {
            onEpochEnd: async (epoch, logs) => {
              globalEpochCounter++;
              document.getElementById("trainingStatus").textContent =
                `Epoch ${globalEpochCounter}: loss = ${logs.loss.toFixed(4)}\n`;
              updateLossChart(globalEpochCounter, logs.loss);
              await tf.nextFrame();
            },
          },
        });
        xs.dispose();
        ys.dispose();
      } finally {
        // Re-enable button and hide spinner.
        trainButton.disabled = false;
        spinner.style.display = "none";
      }
    }

    // --- Inference Function ---
    // This function accepts any input string (even if shorter than SEQ_LENGTH),
    // pads it to SEQ_LENGTH, and then autoregressively predicts 10 next tokens.
    async function runInference() {
      if (!model) {
        alert("Please train the model first!");
        return;
      }
      let prompt = document.getElementById("inputText").value;
      let generated = prompt;
      // Ensure the initial inputSequence is exactly SEQ_LENGTH characters.

      // Autoregressively generate 10 tokens.

      document.getElementById("result").textContent = generated;
    }

  </script>
</body>

</html>